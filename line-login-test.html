<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SaramondƒÅ - LINE Login Test</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 24px;
            padding: 40px;
            max-width: 400px;
            width: 100%;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logo {
            font-size: 48px;
            margin-bottom: 16px;
        }

        h1 {
            color: #fff;
            font-size: 28px;
            margin-bottom: 8px;
        }

        .subtitle {
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 32px;
        }

        .login-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            background: #06C755;
            color: white;
            border: none;
            border-radius: 12px;
            padding: 16px 32px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 20px rgba(6, 199, 85, 0.3);
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(6, 199, 85, 0.4);
        }

        .login-btn:disabled {
            background: #666;
            cursor: not-allowed;
            box-shadow: none;
        }

        .user-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 24px;
            margin-top: 24px;
            text-align: left;
        }

        .user-card img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin-bottom: 16px;
            border: 3px solid #06C755;
        }

        .user-card h3 {
            color: #fff;
            font-size: 20px;
            margin-bottom: 8px;
        }

        .user-card p {
            color: rgba(255, 255, 255, 0.6);
            font-size: 14px;
            margin-bottom: 4px;
            word-break: break-all;
        }

        .user-card .label {
            color: rgba(255, 255, 255, 0.4);
            font-size: 12px;
            text-transform: uppercase;
        }

        .status {
            margin-top: 16px;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
        }

        .status.success {
            background: rgba(6, 199, 85, 0.2);
            color: #06C755;
        }

        .status.error {
            background: rgba(244, 67, 54, 0.2);
            color: #f44336;
        }

        .status.info {
            background: rgba(33, 150, 243, 0.2);
            color: #2196F3;
        }

        .logout-btn {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: rgba(255, 255, 255, 0.6);
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 16px;
            width: 100%;
            transition: all 0.2s;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .hidden {
            display: none;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="logo">üç£</div>
        <h1>SaramondƒÅ</h1>
        <p class="subtitle">Premium Salmon Delivery</p>

        <!-- Login Section -->
        <div id="login-section">
            <button class="login-btn" id="login-btn" onclick="loginWithLine()">
                <svg viewBox="0 0 24 24" width="24" height="24" fill="white">
                    <path
                        d="M19.365 9.863c.349 0 .63.285.63.631 0 .345-.281.63-.63.63H17.61v1.125h1.755c.349 0 .63.283.63.63 0 .344-.281.629-.63.629h-2.386c-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.627-.63h2.386c.349 0 .63.285.63.63 0 .349-.281.63-.63.63H17.61v1.125h1.755zm-3.855 3.016c0 .27-.174.51-.432.596-.064.021-.133.031-.199.031-.211 0-.391-.09-.51-.25l-2.443-3.317v2.94c0 .344-.279.629-.631.629-.346 0-.626-.285-.626-.629V8.108c0-.27.173-.51.43-.595.06-.023.136-.033.194-.033.195 0 .375.104.495.254l2.462 3.33V8.108c0-.345.282-.63.63-.63.345 0 .63.285.63.63v4.771zm-5.741 0c0 .344-.282.629-.631.629-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.627-.63.349 0 .631.285.631.63v4.771zm-2.466.629H4.917c-.345 0-.63-.285-.63-.629V8.108c0-.345.285-.63.63-.63.348 0 .63.285.63.63v4.141h1.756c.348 0 .629.283.629.63 0 .344-.281.629-.629.629M24 10.314C24 4.943 18.615.572 12 .572S0 4.943 0 10.314c0 4.811 4.27 8.842 10.035 9.608.391.082.923.258 1.058.59.12.301.079.766.038 1.08l-.164 1.02c-.045.301-.24 1.186 1.049.645 1.291-.539 6.916-4.078 9.436-6.975C23.176 14.393 24 12.458 24 10.314" />
                </svg>
                Login with LINE
            </button>
            <div id="init-status" class="status info">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î LIFF...</div>
        </div>

        <!-- User Section (Hidden by default) -->
        <div id="user-section" class="hidden">
            <div class="user-card">
                <img id="user-picture" src="" alt="Profile">
                <h3 id="user-name">-</h3>
                <p class="label">LINE User ID</p>
                <p id="user-id">-</p>
                <p class="label" style="margin-top: 12px;">Status Message</p>
                <p id="user-status">-</p>
            </div>
            <div id="sync-status" class="status success">‚úÖ Login ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</div>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
    </div>

    <script>
        // LIFF ID from your configuration
        const LIFF_ID = '2008921790-SyMjjGWY';

        let isLiffInitialized = false;

        // Initialize LIFF on page load
        document.addEventListener('DOMContentLoaded', async () => {
            await initializeLiff();
        });

        async function initializeLiff() {
            const statusEl = document.getElementById('init-status');
            const loginBtn = document.getElementById('login-btn');

            try {
                statusEl.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á Initialize LIFF...';
                statusEl.className = 'status info';

                await liff.init({ liffId: LIFF_ID });
                isLiffInitialized = true;

                console.log('‚úÖ LIFF initialized');
                console.log('isLoggedIn:', liff.isLoggedIn());
                console.log('isInClient:', liff.isInClient());
                console.log('OS:', liff.getOS());

                if (liff.isLoggedIn()) {
                    statusEl.textContent = '‚úÖ LIFF ‡∏û‡∏£‡πâ‡∏≠‡∏° & Login ‡πÅ‡∏•‡πâ‡∏ß';
                    statusEl.className = 'status success';
                    await showUserProfile();
                } else {
                    statusEl.textContent = '‚úÖ LIFF ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô - ‡∏Å‡∏î Login ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢';
                    statusEl.className = 'status success';
                    loginBtn.disabled = false;
                }
            } catch (error) {
                console.error('LIFF init error:', error);
                statusEl.textContent = '‚ùå Error: ' + error.message;
                statusEl.className = 'status error';
                loginBtn.disabled = true;
            }
        }

        function loginWithLine() {
            if (!isLiffInitialized) {
                alert('LIFF ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà');
                return;
            }

            if (liff.isLoggedIn()) {
                showUserProfile();
            } else {
                // Redirect to LINE Login
                liff.login({ redirectUri: window.location.href });
            }
        }

        async function showUserProfile() {
            try {
                const profile = await liff.getProfile();

                console.log('Profile:', profile);

                // Update UI
                document.getElementById('login-section').classList.add('hidden');
                document.getElementById('user-section').classList.remove('hidden');

                document.getElementById('user-picture').src = profile.pictureUrl || 'https://via.placeholder.com/80';
                document.getElementById('user-name').textContent = profile.displayName;
                document.getElementById('user-id').textContent = profile.userId;
                document.getElementById('user-status').textContent = profile.statusMessage || '-';

                // Try to sync with backend
                await syncWithBackend(profile);

            } catch (error) {
                console.error('Get profile error:', error);
                document.getElementById('sync-status').textContent = '‚ùå Error: ' + error.message;
                document.getElementById('sync-status').className = 'status error';
            }
        }

        async function syncWithBackend(profile) {
            const syncStatus = document.getElementById('sync-status');

            try {
                const response = await fetch('http://localhost:3000/api/v1/customers/sync', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${liff.getAccessToken()}`
                    },
                    body: JSON.stringify({
                        lineUserId: profile.userId,
                        displayName: profile.displayName,
                        pictureUrl: profile.pictureUrl
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('Sync response:', data);

                    if (data.isNew) {
                        syncStatus.textContent = 'üéâ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà!';
                    } else {
                        syncStatus.textContent = '‚úÖ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤!';
                    }
                    syncStatus.className = 'status success';
                } else {
                    throw new Error('Backend sync failed');
                }
            } catch (error) {
                console.error('Sync error:', error);
                syncStatus.textContent = '‚ö†Ô∏è Login ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (offline mode)';
                syncStatus.className = 'status info';
            }
        }

        function logout() {
            if (liff.isLoggedIn()) {
                liff.logout();
                window.location.reload();
            }
        }
    </script>
</body>

</html>